# capsule

プログラムを再起動すると変数などに保存されたデータは失われてしまいます。プログラムの停止や再起動に影響を受けずにデータを永続的に保存する方法として、データベースを使用することが一般的です。capsule パッケージは、さほど大きくないデータを JSON 形式でデータベースに登録し永続化するための各種関数を提供します。このパッケージが十全に機能するためには以下の環境変数が登録されている必要があります。

| 変数名                  | 説明                                       |
| ----------------------- | ------------------------------------------ |
| **NS_MARIADB_USER**     | データベースにアクセスするユーザー名       |
| **NS_MARIADB_PASSWORD** | データベースにアクセスするためのパスワード |
| **NS_MARIADB_HOSTNAME** | データベースのホスト名                     |
| **NS_MARIADB_PORT**     | データベースが用意するアクセスポート       |
| **NS_MARIADB_DATABASE** | データベース名                             |

環境変数の頭に NS_MARIADB とつくのは、現在の NeoShowcase の環境変数の設定に合わせることでリポジトリのデプロイ時の操作を単純にするためです。

主な用途として NeoShowcase 上で運用する traQ Bot のためのデータ永続化を想定していますが、他にも何らかの理由で少量のデータを保っておきたい場合にこのパッケージを用いることができます。データベースに対してより高度な操作をする場合は `cps.Db` から [sqlx](https://github.com/jmoiron/sqlx) が用意する関数にアクセスすることができます。詳細は Web エンジニアになろう講習会の『Go でデータベースを扱う』の項を確認してください。

## 変数

### Db

sqlx によって型定義がなされているデータベースアクセス用の変数です。関数 `Connect` あるいはそれを内包する `SetUp` の実行によって内容が定義されます。

```go
var Db *sqlx.DB
```

## 主要関数

### SetUp

`reset` が `true` またはデータベースにまだ値が登録されていないとき、データベースに `origin` を登録して初期化します。`reset` が `false` でデータベースに既に値が登録されている場合には、データベースとの接続のみを実行します。接続や初期化に失敗するとその場で `panic` します。

```go
func SetUp[T any](origin T, reset bool)
```

#### 引数

| 名称       | 説明                                                                         |
| ---------- | ---------------------------------------------------------------------------- |
| **origin** | データベースに登録する初期値。各要素に json タグを持つ構造体である必要がある |
| **reset**  | データベースを必ず初期化するか否か                                           |

### Load

データベースからデータを読み込みます。ジェネリクスの型を指定してください。

```go
func Load[T any]() (T, error)
```

#### 返り値

| 型    | 説明                                                                             |
| ----- | -------------------------------------------------------------------------------- |
| any   | データベースに登録されていたデータ。各要素に json タグを持つ構造体の型で受け取る |
| error | データの読み込みに失敗したときのエラーメッセージ。成功した場合は nil             |

### Save

データベースにデータを登録します。

```go
func Save[T any](config T) error
```

#### 引数

| 名称       | 説明                                                                         |
| ---------- | ---------------------------------------------------------------------------- |
| **config** | データベースに登録するデータ。各要素に json タグを持つ構造体である必要がある |

#### 返り値

| 型    | 説明                                                             |
| ----- | ---------------------------------------------------------------- |
| error | データの登録に失敗したときのエラーメッセージ。成功した場合は nil |

## その他の関数

### Connect

データベースとの接続のみを行います。接続に失敗するとその場で `panic` します。`SetUp` 内で実行されています。もしこのパッケージとは異なる方法でデータベースを活用したい場合には `Connect` のみを実行し、`cps.Db` を利用することができます。

```go
func Connect()
```

### With

`Load` した値に対して処理を行い `Save` をする、という流れの場合は `With` の引数に関数として渡すことでエラーハンドリングを一括で行いシンプルなコードにすることができます。

```go
func With[T any](action func(config *T) error) error
```

#### 引数

| 名称       | 説明                                         |
| ---------- | -------------------------------------------- |
| **action** | データベースの値を用いて実行したい処理の関数 |

#### 返り値

| 型    | 説明                                                                                         |
| ----- | -------------------------------------------------------------------------------------------- |
| error | データの読み込み・書き込み及び途中の処理で失敗したときのエラーメッセージ。成功した場合は nil |

#### 用例

以下の 2 通りのコードはほぼ同じ処理を実行します。

```go
date, err := cps.Load[Date]()
if err != nil {
	return err
}

date.Day = "Sunday"

err := cps.Save(date)
if err != nil {
	return err
}
```

```go
err := cps.With(func(date *Date) error {
	date.Day = "Sunday"
	return nil
})

if err != nil {
	return err
}
```
